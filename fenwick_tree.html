<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns# fb: https://www.facebook.com/2008/fbml">
<head>
    <title>fenwick_tree - Peter's Coding Notes</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="http://peter14f.github.io/pelican-blog/fenwick_tree.html">

        <meta name="author" content="Peter Hsieh" />
        <meta name="keywords" content="BIT,Fenwick Tree" />
        <meta name="description" content="Let&#39;s talk about which problem a Fenwick tree can help us solve. Given an array of n numbers (index 0 to index n-1). Let prefixSum(i) denote the sum of elements from index 0 to index i. Let rangeSum(p, q) denote the sum of elements from index p to index q. (q &gt;= p) Then prefixSum(i) = rangeSum(0, i) rangeSum(p, q) = prefixSum(q) - prefixSum(p-1) for p &gt; 0 rangeSum(p, q) = prefixSum(q) for p = 0 To solve this problem, we could build a prefixSum array which takes O(n) time and with that array we will ..." />

        <meta property="og:site_name" content="Peter's Coding Notes" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="fenwick_tree"/>
        <meta property="og:url" content="http://peter14f.github.io/pelican-blog/fenwick_tree.html"/>
        <meta property="og:description" content="Let&#39;s talk about which problem a Fenwick tree can help us solve. Given an array of n numbers (index 0 to index n-1). Let prefixSum(i) denote the sum of elements from index 0 to index i. Let rangeSum(p, q) denote the sum of elements from index p to index q. (q &gt;= p) Then prefixSum(i) = rangeSum(0, i) rangeSum(p, q) = prefixSum(q) - prefixSum(p-1) for p &gt; 0 rangeSum(p, q) = prefixSum(q) for p = 0 To solve this problem, we could build a prefixSum array which takes O(n) time and with that array we will ..."/>
        <meta property="article:published_time" content="2016-02-28" />
            <meta property="article:section" content="Data Structures" />
            <meta property="article:tag" content="BIT" />
            <meta property="article:tag" content="Fenwick Tree" />
            <meta property="article:author" content="Peter Hsieh" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="http://peter14f.github.io/pelican-blog/theme/css/bootstrap.min.css" type="text/css"/>
    <link href="http://peter14f.github.io/pelican-blog/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="http://peter14f.github.io/pelican-blog/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="http://peter14f.github.io/pelican-blog/theme/css/style.css" type="text/css"/>

        <link href="http://peter14f.github.io/pelican-blog/feeds/all.atom.xml" type="application/atom+xml" rel="alternate"
              title="Peter's Coding Notes ATOM Feed"/>



        <link href="http://peter14f.github.io/pelican-blog/feeds/data-structures.atom.xml" type="application/atom+xml" rel="alternate"
              title="Peter's Coding Notes Data Structures ATOM Feed"/>

</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="http://peter14f.github.io/pelican-blog/" class="navbar-brand">
Peter's Coding Notes            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                        <li class="active">
                            <a href="http://peter14f.github.io/pelican-blog/category/data-structures.html">Data structures</a>
                        </li>
                        <li >
                            <a href="http://peter14f.github.io/pelican-blog/category/java.html">Java</a>
                        </li>
                        <li >
                            <a href="http://peter14f.github.io/pelican-blog/category/leetcode.html">Leetcode</a>
                        </li>
                        <li >
                            <a href="http://peter14f.github.io/pelican-blog/category/misc.html">Misc</a>
                        </li>
                        <li >
                            <a href="http://peter14f.github.io/pelican-blog/category/more-questions.html">More questions</a>
                        </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="http://peter14f.github.io/pelican-blog/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-lg-12">
    <section id="content">
        <article>
                <h2>
                    <a href="http://peter14f.github.io/pelican-blog/fenwick_tree.html"
                       rel="bookmark"
                       title="Permalink to fenwick_tree">
                        fenwick_tree
                    </a>
                </h2>
            <div class="entry-content">
<footer class="post-info">
    <span class="published label label-default">
        <time datetime="2016-02-28T11:36:00-08:00"> Feb 28 2016</time>
    </span>





<span class="label label-default tag-lists">Tags</span>
	<a href="http://peter14f.github.io/pelican-blog/tag/bit.html">BIT</a>
        /
	<a href="http://peter14f.github.io/pelican-blog/tag/fenwick-tree.html">Fenwick Tree</a>
    
</footer><!-- /.post-info -->                <div class="full-article">
                <p>Let's talk about which problem a Fenwick tree can help us solve.</p>
<p>Given an array of <tt class="docutils literal">n</tt> numbers (index <tt class="docutils literal">0</tt> to index <tt class="docutils literal"><span class="pre">n-1</span></tt>).</p>
<p>Let <tt class="docutils literal">prefixSum(i)</tt> denote the sum of elements from index <tt class="docutils literal">0</tt> to index <tt class="docutils literal">i</tt>.
Let <tt class="docutils literal">rangeSum(p, q)</tt> denote the sum of elements from index <tt class="docutils literal">p</tt> to index <tt class="docutils literal">q</tt>. (q &gt;= p)</p>
<p>Then</p>
<pre class="literal-block">
prefixSum(i) = rangeSum(0, i)

rangeSum(p, q) = prefixSum(q) - prefixSum(p-1) for p &gt; 0
rangeSum(p, q) = prefixSum(q)                  for p = 0
</pre>
<p>To solve this problem, we could build a <tt class="docutils literal">prefixSum</tt> array which takes O(n) time and with that array we will be
able to answer the query in O(1) time. But what happens if updates can be made to the original input array?
Each time an update is made, we will have to update our <tt class="docutils literal">prefixSum</tt> array which again takes O(n) time.</p>
<p>Fenwick tree can help us in this case. Each update will only take O(logn) time. And each query will take O(logn) time
as well.</p>
<p>Fenwick tree can be easily implemented using an array and is one-based.</p>
<p>When we build a Fenwick tree from an input array <tt class="docutils literal">nums</tt>. We first initialize our <tt class="docutils literal">tree</tt> array based on the
input array <tt class="docutils literal">nums</tt>. Basically <tt class="docutils literal">tree[i]</tt> = <tt class="docutils literal"><span class="pre">nums[i-1]</span></tt> for i ranging from <tt class="docutils literal">1</tt> to <tt class="docutils literal">n</tt>. And then we loop from
index <tt class="docutils literal">1</tt> to <tt class="docutils literal">n</tt> again, this time adding tree[index] to tree[immediateParentOfIndex].</p>
<p>To understand why we do that, let's look at the following to see how Fenwick tree works.</p>
<pre class="literal-block">
16 -10000 [ 1,15]          |
15 - 1111 [15,15] |        |
14 - 1110 [13,14]   |      |
13 - 1101 [13,13] | |      |
12 - 1100 [ 9,12]     |    |
11 - 1011 [11,11] |   |    |
10 - 1010 [ 9,10]   | |    |
 9 - 1001 [ 9, 9] | | |    |
 8 - 1000 [ 1, 8]       |  |
 7 - 0111 [ 7, 7] |     |  |
 6 - 0110 [ 5, 6]   |   |  |
 5 - 0101 [ 5, 5] | |   |  |
 4 - 0100 [ 1, 4]     | |  |
 3 - 0011 [ 3, 3] |   | |  |
 2 - 0010 [ 1, 2]   | | |  |
 1 - 0001 [ 1, 1] | | | |  |
</pre>
<p>The value of the least-significant-set-bit of the index number tells us how many elements is being covered.</p>
<p>Notice that for every index <tt class="docutils literal">i</tt> there is an immediate parent whose range is bigger than the range of index <tt class="docutils literal">i</tt>
that also covers index <tt class="docutils literal">i</tt>'s range.</p>
<p>You can get to index <tt class="docutils literal">i</tt>'s immediately parent by adding the value of least-significant-set-bit of <tt class="docutils literal">i</tt> to <tt class="docutils literal">i</tt>.</p>
<p>In Java, how do you quick get value when only the least-significant-set-bit of x is set?</p>
<p>x &amp; (-x) would do it</p>
<p>Now that the our Fenwick tree has been built, let's talk about the <tt class="docutils literal">update()</tt> operation because it is extremely
similar to the build tree operation.</p>
<p>The api for <tt class="docutils literal">update()</tt> could be</p>
<dl class="docutils">
<dt>::</dt>
<dd>void update(int index, int newVal)</dd>
</dl>
<p>which is why we actually store the original array in our Fenwick tree class as well, because we want to know
what the delta between <tt class="docutils literal">newVal</tt> and <tt class="docutils literal">oldVal</tt> is.</p>
<p>Remember that <tt class="docutils literal">index</tt> would be in <tt class="docutils literal">tree[index+1]</tt> because Fenwick tree is 1-based. We basically start at
<tt class="docutils literal">i=index+1</tt> and add delta to <tt class="docutils literal">tree[i]</tt> and <tt class="docutils literal">i</tt>'s ancestors (until <tt class="docutils literal">i</tt> exceeds the valid range)</p>
<p>This takes O(logn) time.</p>
<pre class="literal-block">
i = 5 (0b0101), value of least-significant-set-bit is 1 (0b1), 1+5 = 6 is the immediate parent
i = 6 (0b0110), value of least-significant-set-bit is 2 (0b10), 2+6 = 8 is the immediate parent
</pre>
<p>Lastly, let's go over how the <tt class="docutils literal">query()</tt> api is implemented. Notice that in <tt class="docutils literal">buildTree()</tt> and <tt class="docutils literal">update()</tt> we are
moving toward the direction of a larger range (i.e., the parent or going upward). For <tt class="docutils literal">query()</tt> we have to move
toward the other direction.</p>
<p>So instead of adding the least-significant-set-bit value of <tt class="docutils literal">index</tt> to <tt class="docutils literal">index</tt>, we would be subtracting the
least-significant-set-bit value of <tt class="docutils literal">index</tt> from <tt class="docutils literal">index</tt>.</p>
<dl class="docutils">
<dt>::</dt>
<dd>prefixSum(5) = sum(0, 5) = fenwickSum(6) = tree[6] (0b0110) + tree[4] (0b0100)
prefixSum(12) = sum(0, 12) = fenwickSum(13) = tree[13] (0b1101) + tree[12] (0b1100) + tree[8] (0b1000)</dd>
</dl>
<p>Again this is a O(logn) operation.</p>
<p>Just remember that adding the least-significant-set-bit of <tt class="docutils literal">i</tt> to <tt class="docutils literal">i</tt> gets you to the immediate parent of <tt class="docutils literal">i</tt>
and that subtracting the least-significant-set-bit of <tt class="docutils literal">i</tt> to <tt class="docutils literal">i</tt> gets you to the node that covers a non-overlapping
range of sums for numbers that come before <tt class="docutils literal">i</tt>.</p>
<p>If you visualize the above example using a tree, you will get</p>
<pre class="literal-block">
              16
          /  |   |  \
        8    14  15  12
     /  | \   |     /  \
    4   6  7  13   11   10
   / \  |                |
  2   3 5                9
 /
1
</pre>
<p>The point is to illustrate that don't think in terms of the tree structure. Think in terms of the bit representation of
the index.</p>
<div class="highlight"><pre><span class="kd">class</span> <span class="nc">FenwickTree</span> <span class="o">{</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">tree</span><span class="o">;</span>
    <span class="kt">int</span><span class="o">[]</span> <span class="n">arr</span><span class="o">;</span>

    <span class="c1">// buildTree() takes O(n) time</span>
    <span class="kd">public</span> <span class="nf">FenwickTree</span><span class="o">(</span><span class="kt">int</span><span class="o">[]</span> <span class="n">nums</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">];</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">arr</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">nums</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
        <span class="o">}</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tree</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="n">nums</span><span class="o">.</span><span class="na">length</span><span class="o">+</span><span class="mi">1</span><span class="o">];</span>

        <span class="c1">// building the fenwick tree is an O(n) operation</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">tree</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">tree</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">arr</span><span class="o">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">];</span>
        <span class="o">}</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">tree</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="o">(-</span><span class="n">i</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">immediateParent</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">x</span><span class="o">;</span>

            <span class="k">this</span><span class="o">.</span><span class="na">tree</span><span class="o">[</span><span class="n">immediateParent</span><span class="o">]</span> <span class="o">+=</span> <span class="k">this</span><span class="o">.</span><span class="na">tree</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// update() takes O(logn) time</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">,</span> <span class="kt">int</span> <span class="n">newVal</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">newVal</span> <span class="o">-</span> <span class="k">this</span><span class="o">.</span><span class="na">arr</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>

        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">tree</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">tree</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+=</span> <span class="n">delta</span><span class="o">;</span>
            <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="o">(-</span><span class="n">i</span><span class="o">);</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">x</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="c1">// lastly update our copy of the array as well</span>
        <span class="k">this</span><span class="o">.</span><span class="na">arr</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">newVal</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// query() takes O(logn) time</span>
    <span class="c1">// this answers sum(0, index)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">query</span><span class="o">(</span><span class="kt">int</span> <span class="n">index</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">sum</span> <span class="o">+=</span> <span class="k">this</span><span class="o">.</span><span class="na">tree</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="n">i</span> <span class="o">&amp;</span> <span class="o">(-</span><span class="n">i</span><span class="o">);</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">x</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">sum</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

                </div>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2018 Peter Hsieh
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="http://peter14f.github.io/pelican-blog/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="http://peter14f.github.io/pelican-blog/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="http://peter14f.github.io/pelican-blog/theme/js/respond.min.js"></script>


</body>
</html>